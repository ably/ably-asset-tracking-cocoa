default_platform(:ios)

platform :ios do
  desc 'Run tests on all targets'
  lane :test_all do
    test_core
    test_internal
    test_subscriber
    test_publisher
    test_system
  end

  desc 'Run Core tests'
  lane :test_core do
    xcodebuild(
      scheme: 'CoreTests',
      configuration: 'Debug',
      destination: 'platform=iOS Simulator,name=iPhone 12',
      test: "test"
    )
  end

  desc 'Run Internal tests'
  lane :test_internal do
    xcodebuild(
      scheme: 'InternalTests',
      configuration: 'Debug',
      destination: 'platform=iOS Simulator,name=iPhone 12',
      test: "test"
    )
  end

  desc 'Run Subscriber tests'
  lane :test_subscriber do
    xcodebuild(
      scheme: 'SubscriberTests',
      configuration: 'Debug',
      destination: 'platform=iOS Simulator,name=iPhone 12',
      test: "test"
    )
  end

  desc 'Run Publisher tests'
  lane :test_publisher do
    xcodebuild(
      scheme: 'PublisherTests',
      configuration: 'Debug',
      destination: 'platform=iOS Simulator,name=iPhone 12',
      test: "test"
    )
  end

    desc 'Run System tests'
    lane :test_system do
      xcodebuild(
        scheme: 'SystemTests',
        configuration: 'Debug',
        destination: 'platform=iOS Simulator,name=iPhone 12',
        test: "test"
      )
    end

  desc 'Build Subscriber SDK and export is as .framework file'
  lane :build_subscriber do
    xcodebuild(
      archive: true,
      workspace: './AblyAssetTracking.xcworkspace',
      scheme: 'AblyAssetTrackingSubscriber',
      destination: 'generic/platform=iOS',
      archive_path: 'archives/Subscriber.xcarchive',
      xcargs: 'SKIP_INSTALL=NO',
    )
  end

  desc 'Build Publisher SDK and export is as .framework file'
  lane :build_publisher do
    xcodebuild(
      archive: true,
      workspace: './AblyAssetTracking.xcworkspace',
      scheme: 'AblyAssetTrackingPublisher',
      destination: 'generic/platform=iOS',
      archive_path: 'archives/Publisher.xcarchive',
      xcargs: 'SKIP_INSTALL=NO',
    )
  end

  desc 'Build example apps to validate that there are no build errors'
  lane :build_example_apps do
    xcodebuild(
      workspace: './AblyAssetTracking.xcworkspace',
      scheme: 'PublisherExample',
      configuration: 'Debug',
      sdk: 'iphonesimulator',
      arch: 'x86_64'
    )

    xcodebuild(
      workspace: './AblyAssetTracking.xcworkspace',
      scheme: 'SubscriberExample',
      configuration: 'Debug',
      sdk: 'iphonesimulator',
      arch: 'x86_64'
    )
  end
end
